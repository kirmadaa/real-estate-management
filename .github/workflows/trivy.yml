name: TaskApi - E1 â†’ E2 US Hydra with Trivy Remediation v2

on:
  workflow_dispatch:

env:
  DOCKER_HUB_USERNAME: kiramdadaa
  IMAGE_NAME: taskapi-frontend  # Change this to your preferred image name

jobs:
  set_env:
    name: ðŸ›  Set Variables
    runs-on: ubuntu-latest
    outputs:
      image_name: ${{ steps.setvars.outputs.image_name }}
      image_tag: ${{ steps.setvars.outputs.image_tag }}
      checkout_branch: ${{ steps.setvars.outputs.checkout_branch }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set environment variables
        id: setvars
        run: |
          echo "image_name=${{ env.IMAGE_NAME }}" >> $GITHUB_OUTPUT
          echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "checkout_branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

  ace-build:
    name: ðŸ³ Build and Push Docker Image
    needs: set_env
    runs-on: ubuntu-latest
    outputs:
      pushed_image: ${{ steps.push.outputs.image }}
    steps:

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          buildkitd-flags: --debug
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: kirmadadaa
          password: hnguhngu1

      - name: Build and Push Docker Image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: frontend/
          file: frontend/Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.set_env.outputs.image_tag }}
            ${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
        env:
          DOCKER_BUILDKIT: 1

      - name: Set output
        run: |
          echo "image=${{ env.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ needs.set_env.outputs.image_tag }}" >> $GITHUB_OUTPUT

  trivy-scan:
    name: ðŸ” Trivy Scan
    needs: ace-build
    runs-on: ubuntu-latest
    outputs:
      vulns: ${{ steps.parse.outputs.vulns }}
    env:
      IMAGE: ${{ needs.ace-build.outputs.pushed_image }}
      SCAN_REPORT: trivy-report.json
    steps:
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v0.40.6

      - name: Run Trivy on published image
        run: |
          echo "Scanning $IMAGE"
          trivy image --format json --output $SCAN_REPORT $IMAGE || true

      - name: Parse vulnerability count
        id: parse
        run: |
          count=$(jq '[.Results[].Vulnerabilities[]?] | length' $SCAN_REPORT)
          echo "vulns=$count" >> $GITHUB_OUTPUT

      - name: Upload Trivy Report
        uses: actions/upload-artifact@v3
        with:
          name: trivy-report
          path: $SCAN_REPORT

  remediation:
    name: ðŸ”§ Automated Remediation
    needs: [set_env, trivy-scan]
    if: needs.trivy-scan.outputs.vulns != '0'
    runs-on: ubuntu-latest
    env:
      BRANCH: ${{ needs.set_env.outputs.checkout_branch }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BRANCH }}

      - name: Run remediation script
        run: |
          chmod +x .github/scripts/remediate.sh
          ./.github/scripts/remediate.sh

      - name: Commit & push fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add frontend/Dockerfile package.json requirements.txt || true
          git commit -m "Automated remediation fixes" || echo "No changes to commit"
          git push origin $BRANCH

  # Uncomment and modify these deployment jobs as needed
  # ccli_hydra_e1_deployment:
  #   name: ðŸš€ðŸŸ¡ Deploy image to E1 Hydra
  #   needs: [set_env, ace-build, trivy-scan]
  #   uses: amex-eng/ace-platform-reusable-workflow/.github/workflows/deploy_to_hydra_ccli_validate.yml@main
  #   with:
  #     image_name_ccli: artifactory.aexp.com/dockerproxy/${{ needs.set_env.outputs.image_name }}
  #     sha256: ${{ needs.ace-build.outputs.pushed_image }}
  #     regions: US
  #     env: "E1"
  #     project: ${{ vars.PROJECT }}
  #     service: ${{ vars.SERVICE }}
  #     image_time_stamp: ${{ needs.set_env.outputs.image_tag }}
  #   secrets:
  #     SE_USERNAME: ${{ secrets.SE_USERNAME }}
  #     SE_PASSWORD: ${{ secrets.SE_PASSWORD }}
  #     ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
  #     ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}

  # ccli_hydra_e2_deployment:
  #   name: ðŸš€ðŸŸ  Deploy image to E2 Hydra
  #   needs: [set_env, ace-build, trivy-scan, ccli_hydra_e1_deployment]
  #   uses: amex-eng/ace-platform-reusable-workflow/.github/workflows/deploy_to_hydra_ccli_validate.yml@main
  #   with:
  #     image_name_ccli: artifactory.aexp.com/dockerproxy/${{ needs.set_env.outputs.image_name }}
  #     sha256: ${{ needs.ace-build.outputs.pushed_image }}
  #     regions: US
  #     env: "E2"
  #     project: ${{ vars.PROJECT }}
  #     service: ${{ vars.SERVICE }}
  #     image_time_stamp: ${{ needs.set_env.outputs.image_tag }}
  #   secrets:
  #     SE_USERNAME: ${{ secrets.SE_USERNAME }}
  #     SE_PASSWORD: ${{ secrets.SE_PASSWORD }}
  #     ARTIFACTORY_USERNAME: ${{ secrets.ARTIFACTORY_USERNAME }}
  #     ARTIFACTORY_PASSWORD: ${{ secrets.ARTIFACTORY_PASSWORD }}
